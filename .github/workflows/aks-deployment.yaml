name: CI/CD AKS Deployment

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # -------------------------
      # Checkout Source Code
      # -------------------------
      - name: Checkout code
        uses: actions/checkout@v3

      # -------------------------
      # Setup Kubectl
      # -------------------------
      - name: Set up Kubernetes CLI
        uses: azure/setup-kubectl@v3

      # -------------------------
      # Login to Azure
      # -------------------------
      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # -------------------------
      # Connect to AKS Cluster
      # -------------------------
      - name: Set AKS context
        run: |
          az aks get-credentials \
            --resource-group ${{ secrets.AKS_RESOURCE_GROUP }} \
            --name ${{ secrets.AKS_CLUSTER_NAME }} \
            --overwrite-existing

      # -------------------------
      # Setup Helm
      # -------------------------
      - name: Helm setup
        uses: azure/setup-helm@v3

      # -------------------------
      # Install External Secrets CRDs
      # FIX: Using server-side apply to avoid patch errors
      # -------------------------
      - name: Install External Secrets CRDs (safe server-side apply)
        run: |
          kubectl apply --server-side --force-conflicts \
            -f https://raw.githubusercontent.com/external-secrets/external-secrets/main/deploy/crds/bundle.yaml

      # -------------------------
      # Install External Secrets Operator
      # -------------------------
      - name: Install External Secrets Operator (idempotent)
        run: |
          helm repo add external-secrets https://charts.external-secrets.io/
          helm repo update

          # Install operator
          helm upgrade --install external-secrets external-secrets/external-secrets \
            --namespace external-secrets \
            --create-namespace

      # -------------------------
      # Deploy Application via Helm
      # -------------------------
      - name: Deploy Helm chart
        run: |
          helm upgrade --install frontend ./helmcharts \
            -n frontend-dev \
            -f docker-dev-fe-values.yaml \
            --atomic --timeout 10m \
            --create-namespace

