{{- if and (eq .Values.workloads.type "deployment") (hasKey .Values "deployment") (hasKey .Values.deployment "rollout") (hasKey .Values "deployment") .Values.deployment.rollout.enabled }}
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: {{ .Values.app.name }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "app.labels" $ | nindent 4 }}
  {{- with .Values.app.deployment.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  replicas: {{ .Values.app.deployment.replicas | default 1 }}
  revisionHistoryLimit: 3
  selector:
    matchLabels:
      app: {{ .Values.app.name }}
  strategy:
    canary:
      {{- if .Values.app.deployment.rollout.strategy.trafficRouting.enabled }}
      trafficRouting:
        istio:
          virtualService:
            name: {{ .Values.app.name }}-vs
          destinationRule:
            name: {{ .Values.app.name }}-destinationrule
            canarySubsetName: {{ .Values.app.deployment.rollout.strategy.trafficRouting.canarySubsetName | default "canary" }}
            stableSubsetName: {{ .Values.app.deployment.rollout.strategy.trafficRouting.stableSubsetName | default "stable" }}
      {{- end }}
      {{- if .Values.deployment.rollout.strategy.steps }}
      steps:
        {{- toYaml .Values.deployment.rollout.strategy.steps | nindent 6 }}
      {{- else }}
      steps: []
      {{- end }}
  template:
    {{- include "app.podTemplate" . | nindent 4 }}
{{- end }}
